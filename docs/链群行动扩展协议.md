# 链群行动扩展协议（初稿）

## 1. 关于协议

此扩展协议，基于 LOVE20 扩展协议标准，扩展行动参与机制，允许行动者以链群的方式参与行动。

- 行动者可自由加入退出所选链群，进行可验证的共识行动
- 行动者基于所在链群的链群服务者的验证结果获得行动铸币激励
- 支持此行动的治理者，通过不信任投票降低特定链群整体收益的方式，来监督和惩罚作弊或违背行动验证规则的链群

## 2. 初始参数

### 2.1 代币合约地址

表示链群行动所在的代币，激活所需要的质押代币也是这个代币。

### 2.2 激活需质押代币数量

链群服务者激活链群时需质押的代币数量

### 2.3 参与代币合约地址

行动者参与行动时使用的代币地址，支持以下两种类型：

| 类型 | 说明                         | 校验规则                              |
| ---- | ---------------------------- | ------------------------------------- |
| 1    | tokenAddress 本身            | 地址相等                              |
| 2    | 包含 tokenAddress 的 LP 代币 | LP.token0 或 LP.token1 = tokenAddress |

若设置为 LP 代币，行动者的参与价值将自动转换为 tokenAddress 价值。

### 2.4 最大参与代币占比

- 单个行动者最大参与代币数 = 已铸造参与代币总量 \* 最大参与代币占比 \* 行动当轮投票率

### 2.5 最大验证容量系数

- 最大可验证容量 = 治理票占比 \* 已铸造参与代币量 \* 最大验证容量系数

## 3. 治理者

### 3.1 不信任投票

在验证阶段对一个或多个链群服务者进行不信任投票：

- 投票上限：对单个链群服务者的不信任票数 ≤ 自己给扩展协议合约投的验证票数
- 投票目的：惩罚验证不公或有其他作恶行为的链群服务者
- 投票效果：降低该链群服务者所服务的所有链群的铸币激励
- 说明理由：投不信任票时同时提交原因在链上公示

链群验证者的不信任率 = 链群服务者收到的不信任票总数 / 此行动的投票总数

投不信任票会同步额外更新数据：

- 被投链群服务者已验证的每个链群的得分：链群参与代币总量 \* (1 - 链群验证者的不信任率) \* 容量降权系数
- 行动总得分：已验证链群累计得分

## 4. 链群服务者

- 在[链群](https://love20tkm.github.io/group/)里铸造自己的链群 NFT 并在链群行动中激活链群成为链群服务者
- 获得已激活的链群对应的 NFT

### 4.1 链群激活或恢复

治理者可以选择自己持有的链群 NFT ，质押代币激活所需代币数量（使用链群行动所在的代币），激活一个新链群或恢复旧链群。

激活时需提供：

- 链群说明：例如：一些注意事项，以及如何联系到链群服务者，如何加入所在链群的行动者群（例如：QQ 群、微信验证群）等
- 最大容量：行动者参与此链群的累计最大代币参与量
- 行动者最小参与量
- 行动者最大参与量（可选）：0 为不做限制
- 行动者最大地址数（可选）：0 为不做限制

恢复链群时，自动继承原链群中所有未退出的行动者

### 4.2 链群更新

立即更新，并在当轮立即生效（不影响已参与的行动者）

- 链群说明
- 最大容量
- 行动者最小参与量
- 行动者最大参与量
- 行动者最大地址数

### 4.3 链群验证

持有链群 NFT 的人为作为链群服务者，可以提交验证，完整验证会同时更新下面 4 类得分

- 行动者得分：每轮的验证阶段，链群服务者（持有链群 NFT ）基于行动的验证规则，提交每个行动者的原始得分\[0~100\]，并计算每个行动者的最终得分：行动者的原始得分 \* 参与代币数量
- 链群内所有行动者总得分：简化后续计算行动者激励
- 链群得分生成：链群参与代币总量 \* (1 - 链群验证者的不信任率) \* 容量降权系数
- 行动总得分：已验证链群累计得分

合约自动记录每轮的历史数据（行动代币参与总量、链群参与代币总量、每个行动者的参与代币数），验证时基于当轮的历史数据计算得分。

#### 4.3.1 批量验证机制

链群验证支持分批提交，允许链群服务者分多次完成整个链群的验证：

- **分批提交**：链群服务者可以分多次调用验证接口，每次提交一批行动者的原始得分
- **顺序验证**：每次提交时必须指定 `startIndex`（起始索引），该值必须等于已验证的账户数量，确保验证按顺序进行
- **批量得分数组**：每次提交时提供 `originScores` 数组，包含从 `startIndex` 开始的一批账户的原始得分（范围 0~100）
- **自动完成**：当所有账户都验证完成后（已验证账户数 = 链群总账户数），合约自动完成验证并计算最终得分
- **累计计算**：每次分批提交都会累计更新已验证账户数量和链群总得分，直到所有账户验证完成

**示例**：

- 链群有 100 个行动者
- 第 1 次提交：`startIndex = 0`，`originScores = [80, 90, 85, ...]`（前 30 个账户的得分）
- 第 2 次提交：`startIndex = 30`，`originScores = [75, 88, ...]`（第 31-60 个账户的得分）
- 第 3 次提交：`startIndex = 60`，`originScores = [92, 85, ...]`（第 61-100 个账户的得分）
- 第 3 次提交完成后，所有账户验证完成

#### 4.3.2 容量降权系数计算

验证时根据服务者的最大可验证容量来计算容量降权系数：

- 剩余可验证容量 = 最大可验证容量 - 已验证链群的代币参与总量
- 若剩余可验证容量 >= 待验证链群实际容量：容量降权系数 = 1（不降权）
- 若剩余可验证容量 < 待验证链群实际容量且 > 0：容量降权系数 = 剩余可验证容量 / 待验证链群实际容量
- 若剩余可验证容量 = 0：验证失败

注意：

- 若当前轮次链群服务者未能成功提交链群验证，则自动放弃本链群所有激励，分给行动下其他链群

#### 4.4 链群指定验证代理

链群服务者可为链群设定一个钱包地址作为链群验证代理，验证代理可以代替链群服务者提交链群的验证结果。

#### 所有者检查机制

为确保安全性，系统实现了严格的所有者检查机制：

- **设置时记录所有者**：当链群服务者设置验证代理时，系统会记录设置时的链群 NFT 所有者地址
- **验证时检查所有者**：每次验证时，系统会检查：
  1. 验证代理地址是否匹配
  2. 设置验证代理时的所有者是否与当前链群 NFT 所有者一致
- **NFT 转移后自动失效**：若链群 NFT 被转移到其他地址，即使验证代理地址未改变，验证也会失败，因为设置时的所有者与当前所有者不匹配
- **查询时也检查**：查询验证代理地址时，如果所有者不匹配，会返回空地址（表示验证代理已失效）

**安全考虑**：

- 防止链群 NFT 转移后，原所有者设置的验证代理继续有效
- 确保只有当前链群 NFT 持有者或其设置的验证代理才能进行验证
- 新链群所有者需要重新设置验证代理（如果需要）

### 4.5 链群取消激活

链群服务者在链群创建后的下一轮开始，可随时取消激活链群，并立即返还质押代币（使用链群行动所在的代币）。

链群取消激活后，行动者可继续领取之前未领取的行动铸币激励。

已取消激活的链群，新行动者无法加入，现有行动者也无法追加代币；还未验证的链群也无法再接受验证。

注意：质押代币返还给当前持有链群 NFT 的地址。若链群 NFT 已转移，质押代币将返还给新持有者。

## 5. 行动者

### 5.1 加入行动

行动者指定链群参与行动时：

- 首次参与，参与代币数不低于行动提交时设置的最小参与量和所选链群行动者最小参与量
- 累计参与代币数不超过单个行动者最大参与代币数、所选链群行动者最大参与量
- 不超过超过链群行动者最大地址数
- 加入后链群服务者激活的所有链群的代币参与总量不超过最大可验证容量

### 5.2 铸造行动激励

行动者加入后，下一轮开始验证，验证后可铸造自己的行动激励

行动者的行动铸币激励 = 行动者得分 / 链群内所有行动者得分 \* 链群铸币激励

链群铸币激励 = 行动总激励 × 链群得分 / 行动内所有链群得分

### 5.3 退出行动

可随时退出并立即返还累计参与的所有代币

## 6. 特殊情况

若某轮所有链群都未能提交验证，则验证阶段结束后，任何人可触发行动激励销毁，销毁此行动所有可铸造激励，将代币变为未铸造
