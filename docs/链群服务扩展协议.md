# 链群服务扩展协议（初稿）

## 1. 关于协议

此扩展协议，基于 LOVE20 扩展协议标准，扩展行动参与机制，对链群行动中的链群服务者做激励

- 参与方式：在链群行动中激活链群，并服务链群行动参与者；同时参与链群服务行动
- 自动计算：链上自动计算铸币激励
- 激励分配：支持设置多个接收地址和分配比例，在铸造激励时自动分配

## 2. 初始参数

- 链群服务所在代币地址（tokenAddress）
- 链群行动所在代币地址：仅限链群服务所在代币地址或其子币地址
- 链群行动扩展协议工厂合约地址
- 激励分配地址数上限

## 3. 质押代币价值计算

链群行动可使用多种类型的代币作为质押代币（stakeToken），系统会自动将质押量转换为链群服务所在代币（tokenAddress）的等值价值：

| 质押代币类型                   | 转换方式                                  |
| ------------------------------ | ----------------------------------------- |
| tokenAddress 本身              | 直接返回，无需转换                        |
| tokenAddress 的子代币          | 通过 Uniswap V2 交易对转换                |
| 与 tokenAddress 有交易对的代币 | 通过 Uniswap V2 交易对转换                |
| 包含 tokenAddress 的 LP 代币   | tokenAddress 那边储备量 × 2 / LP 总供应量 |

### 3.1 转换公式

**Uniswap 交易对转换：**

```
tokenAddress 价值 = 质押量 × tokenAddress 储备量 / stakeToken 储备量
```

**LP 代币转换：**

```
tokenAddress 价值 = (tokenAddress 储备量 × LP 质押量 × 2) / LP 总供应量
```

LP 代币两边价值相等（AMM 恒定乘积机制），因此只需计算 tokenAddress 那边的储备量乘以 2。

### 3.2 特殊情况

- 若 stakeToken 与 tokenAddress 之间无 Uniswap 交易对，返回 0（不计入总量）
- 若交易对流动性为 0，返回 0
- LP 代币必须包含 tokenAddress 作为底层资产之一

## 4. 激励铸造

链群服务激励 = 链群服务行动总激励 × 链群服务者已服务的所有行动的所有链群铸币激励 / 所有链群行动的行动激励总和

注意，这里的行动是指：

- 链群行动所在代币地址下的行动
- 行动的白名单地址是工厂合约所创建的扩展协议

## 5. 激励分配

链群服务激励可以设置二次分配，在铸造激励的时候，自动分配到设置的所有地址，剩余部分默认为链群服务者的激励。

### 5.1 分配设置

链群服务者可以在验证阶段，对行动下的链群进行分配设置

- 设置维度：每个行动下的每个链群可以有不同的分配配置
- 基点范围：1-1e18（1e18 = 100%）
- 基点总和不能超过 1e18
- 接收地址数不可超过设定的上限
- 剩余部分（1e18 - 基点总和）归链群服务者所有
- 同一阶段可多次设置，以最后一次设置为准
- 若当轮某链群未设置，则向前查找该链群最近一轮的设置
- 链群服务者在领取激励时，按每个链群的分配设置分别分配激励

### 5.2 历史记录

- 可按行动查询某链群某轮最终生效的设置
- 可查询行动下某链群某轮的激励分配明细
- 可查询某轮所有链群的激励分配汇总

### 5.3 分配计算

激励按链群维度分别计算：

```
链群A的激励 = 链群服务总激励 × 链群A铸币激励 / 所有链群行动总激励

链群A某接收地址的激励 = 链群A的激励 × 该地址基点 / 1e18
链群A链群服务者的激励 = 链群A的激励 - 链群A所有接收地址激励之和
```
